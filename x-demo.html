<link rel="import" href="bower_components/polymer/polymer-element.html">

<!-- import CSS mixins polyfill -->
<link rel="import" href="bower_components/shadycss/apply-shim.html">

<!-- gesture event support -->
<link rel="import" href="bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="bower_components/neon-animation/web-animations.html">

<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/social-icons.html">
<link rel="import" href="bower_components/iron-list/iron-list.html">
<link rel="import" href="bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-item/paper-icon-item.html">

<link rel="import" href="bower_components/emojione-selector/emojione-selector.html">

<dom-module id="x-demo">
  <template>
    <custom-style>
      <style>
        :host {
          @apply(--layout-vertical);
          @apply(--layout-fullbleed);
        }
        iron-list {
          @apply(--layout-flex);
          padding: 0 8px;
          background-color: var(--paper-grey-100);
        }
        iron-list .message {
          display: inline-block;
          padding: 8px;
          border-radius: 3px;
          background-color: var(--paper-grey-300);
          margin-top: 8px;
        }
        iron-list .message.right {
          float: right;
        }
        iron-list .message img {
          vertical-align: middle;
          height: 24px;
          width: 24px;
        }
        .demo-bottom {
          @apply(--layout-horizontal);
          @apply(--layout-end);
          padding: 8px;
        }
        paper-input {
          @apply(--layout-flex);
          --paper-input-container-focus-color: var(--paper-blue-500);
          margin: 0 8px;
        }
        paper-button {
          background-color: var(--paper-blue-500);
          color: #fff;
          margin-bottom: 8px;
        }
        emojione-selector {
          --emojione-selector-iron-list: {
            background-color: var(--paper-grey-50);
          }
          --paper-input-container-focus-color: var(--paper-blue-500);
          --paper-tabs-selection-bar-color: var(--paper-blue-500);
        }

      </style>
    </custom-style>

    <iron-ajax url="messages.json" last-response="{{messages}}" auto></iron-ajax>

    <iron-list id="messages" items="[[messages]]" as="item">
      <template>
        <div>
          <div class$="message [[item.side]]">
            <span inner-h-t-m-l="{{getMessage(item.message)}}"></span>
          </div>
        </div>
      </template>
    </iron-list>
    <iron-collapse opened="{{opened}}">
      <emojione-selector opened="{{opened}}" emoji="{{emoji}}"></emojione-selector>
    </iron-collapse>
    <div class="demo-bottom">
      <paper-icon-button on-tap="onEmojiButtonTap" icon="{{computeIfChatIcon(opened)}}" src="{{computeIfChatImg(opened)}}" title="emoji"></paper-icon-button>
      <paper-input label="Type something" value="{{message}}" no-label-float></paper-input>
      <paper-button on-tap="onSendButtonTap" raised>Send</paper-button>
    </div>
  </template>
  <script>

    class XDemo extends Polymer.GestureEventListeners(Polymer.Element) {

      static get is() {
        return 'x-demo';
      }

      static get properties() {
        return {
          opened: {
            type: Object
          },
          messages: {
            type: Array
          },
          message: {
            type: String,
            value: ''
          },
          emoji: {
            type: String
          }
        };
      }

      static get observers() {
        return ['onEmojiChange(emoji)'];
      }

      ready() {
        super.ready();

        // HACK force re-render of iron list
        window.setTimeout(() => {
          this.$.messages.notifyResize();
        }, 600);
      }

      computeIfChatIcon(opened) {
        if (opened) {
          return '';
        } else {
          return 'social:mood';
        }
      }

      computeIfChatImg(opened) {
        if (opened) {          
          return 'https://cdn.jsdelivr.net/emojione/assets/3.0/png/32/1f642.png';
        } else {
          return '';
        }
      }

      getMessage(message) {
        return emojione.toImage(message);
      }

      onEmojiChange(emoji) {
        if (emoji) {
          this.message = this.message + this.emoji;
        }
      }

      onEmojiButtonTap() {
        this.opened = !this.opened;
      }

      onSendButtonTap() {
        if (this.message) {
          this.push('messages', {
            'side': 'right',
            'message': this.message
          });

          this.message = '';
        }
      }
    }

    window.customElements.define(XDemo.is, XDemo);
  </script>
</dom-module>